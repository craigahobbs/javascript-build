if [ "$(docker images -q node:18-slim)" = "" ]; then docker pull -q node:18-slim; fi
docker run -i --rm -u `id -u`:`id -g` -v `pwd`:`pwd` -w `pwd` -e HOME=`pwd`/build node:18-slim npm install --save-dev \
  ava@'~X.Y' \
  c8@'~X.Y' \
  eslint@'~X.Y' \
  jsdoc@'~X.Y' \
  jsdom@'~X.Y'
mkdir -p build/
touch build/npm.build
docker run -i --rm -u `id -u`:`id -g` -v `pwd`:`pwd` -w `pwd` -e HOME=`pwd`/build node:18-slim npx ava -v test/
docker run -i --rm -u `id -u`:`id -g` -v `pwd`:`pwd` -w `pwd` -e HOME=`pwd`/build node:18-slim npx eslint -c .eslintrc.cjs -f unix .eslintrc.cjs lib/ test/
docker run -i --rm -u `id -u`:`id -g` -v `pwd`:`pwd` -w `pwd` -e HOME=`pwd`/build node:18-slim npx jsdoc --pedantic -d build/doc/ -c jsdoc.json -r README.md lib/
docker run -i --rm -u `id -u`:`id -g` -v `pwd`:`pwd` -w `pwd` -e HOME=`pwd`/build node:18-slim npx c8 -o build/coverage --temp-dir build/tmp -r html -r text --100 --all --allowExternal --src lib/ --src test/ \
  npx ava -v test/
if [ ! -d ../gh-pages.gh-pages ]; then git clone -b gh-pages `git config --get remote.origin.url` ../gh-pages.gh-pages; fi
cd ../gh-pages.gh-pages && git pull
rsync -rv --delete --exclude=.git/ build/doc/ ../gh-pages.gh-pages
touch ../gh-pages.gh-pages/.nojekyll
